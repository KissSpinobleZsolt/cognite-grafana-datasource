<query-editor-row query-ctrl="ctrl" can-collapse="true">
  <div class="gf-form-group">
    <!-- tabs -->
    <div class="tabbed-view-header">
      <ul class="gf-tabs">
        <li class="gf-tabs-item" ng-repeat="tab in ctrl.tabs">
          <a
            class="gf-tabs-link gf-tabs-cognite"
            ng-click="ctrl.changeTab($index)"
            ng-class="{active: ctrl.currentTabIndex === $index}"
          >
            {{ tab.name }}
          </a>
        </li>
      </ul>
    </div>

    <!-- body -->
    <div ng-repeat="tab in ctrl.tabs" ng-if="ctrl.currentTabIndex == $index">
      <div ng-include src="tab.src" class="share-modal-body"></div>
    </div>

    <!-- error messages -->
    <div class="gf-form-inline panel-container">
      <label class="gf-form-label--error">{{ ctrl.target.error }}</label>
    </div>
  </div>
</query-editor-row>

<!-- Timeseries Tab -->
<script type="text/ng-template" id="timeseriestab.html">
  <div class="gf-form-inline">
     <div class="gf-form">
       <label class="gf-form-label query-keyword fix-query-keyword">Tag</label>
       <gf-form-dropdown model="ctrl.target.target"
         css-class="gf-size-auto"
         allow-custom="false"
         lookup-text="true"
         get-options="ctrl.getOptions($query,'Timeseries')"
         on-change="ctrl.onChangeInternal()">
       </gf-form-dropdown>
     </div>
     <div class="gf-form">
       <label class="gf-form-label query-keyword fix-query-keyword">Aggregation</label>
       <select class="gf-form-input" ng-model="ctrl.target.aggregation" ng-change="ctrl.onChangeInternal()">
       <option ng-repeat="fn in ctrl.aggregation" value="{{fn.value}}">{{fn.name}}</option>
       </select>
     </div>
     <div class="gf-form" ng-if="ctrl.target.aggregation && ctrl.target.aggregation !== 'none'">
       <label class="gf-form-label query-keyword fix-query-keyword">Granularity</label>
       <input type="text" class="gf-form-input width-8" ng-model="ctrl.target.granularity" ng-blur="ctrl.onChangeInternal()" placeholder="default"/>
       <info-popover mode="right-absolute">
           The granularity of the aggregate values. Valid entries are: 'day/d, hour/h, minute/m, second/s'. Example: 12hour.
       </info-popover>
     </div>
     <div class="gf-form gf-form--grow">
       <label class="gf-form-label query-keyword fix-query-keyword">Label</label>
       <input type="text" class="gf-form-input" ng-model="ctrl.target.label" ng-blur="ctrl.onChangeInternal()" placeholder=""/>
       <info-popover mode="right-absolute">
         <span ng-non-bindable>
           Set the label for the timeseries. Can also access timeseries properties via {{property}}. Eg: {{description}}-{{metadata.key}}
         </span>
       </info-popover>
     </div>
   </div>
</script>

<!-- Select Timeseries from Asset tab -->
<script type="text/ng-template" id="assettab.html">
  <div class="gf-form-inline">
    <div class="gf-form">
      <label class="gf-form-label query-keyword fix-query-keyword">Asset Tag</label>
      <gf-form-dropdown model="ctrl.target.assetQuery.target"
        css-class="gf-size-auto"
        allow-custom="false"
        lookup-text="true"
        get-options="ctrl.getOptions($query,'Asset')"
        on-change="ctrl.onChangeInternal()">
      </gf-form-dropdown>
    </div>
    <div class="gf-form">
      <gf-form-switch class="gf-form"
        label="Include Subassets" label-class="width-9 query-keyword fix-query-keyword"
        checked="ctrl.target.assetQuery.includeSubtrees" on-change="ctrl.onChangeInternal()">
      </gf-form-switch>
    </div>
     <div class="gf-form">
      <label class="gf-form-label query-keyword fix-query-keyword">Aggregation</label>
      <select class="gf-form-input" ng-model="ctrl.target.aggregation" ng-change="ctrl.onChangeInternal()">
      <option ng-repeat="fn in ctrl.aggregation" value="{{fn.value}}">{{fn.name}}</option>
      </select>
    </div>
    <div class="gf-form" ng-if="ctrl.target.aggregation && ctrl.target.aggregation !== 'none'">
      <label class="gf-form-label query-keyword fix-query-keyword">Granularity</label>
      <input type="text" class="gf-form-input width-8" ng-model="ctrl.target.granularity" ng-blur="ctrl.onChangeInternal()" placeholder="default"/>
      <info-popover mode="right-absolute">
          The granularity of the aggregate values. Valid entries are: 'day/d, hour/h, minute/m, second/s'. Example: 12hour.
      </info-popover>
    </div>
    <div class="gf-form gf-form--grow">
        <label class="gf-form-label query-keyword fix-query-keyword">Label</label>
        <input type="text" class="gf-form-input" ng-model="ctrl.target.label" ng-blur="ctrl.onChangeInternal()" placeholder=""/>
        <info-popover mode="right-absolute">
          <span ng-non-bindable>
            Set the label for each timeseries. Can also access timeseries properties via {{property}}. Eg: {{description}}-{{metadata.key}}
          </span>
        </info-popover>
    </div>
  </div>
  <div class="panel-container" style="overflow: auto; max-height: 110px; padding: 2px">
    <ul>
      <li ng-repeat="timeseries in ctrl.target.assetQuery.timeseries">
        <input type="checkbox" ng-model="timeseries.selected" ng-change="ctrl.onChangeInternal()"> {{timeseries.name}}
      </li>
    </ul>
  </div>
</script>

<!-- Custom Query Tab -->
<script type="text/ng-template" id="customtab.html">
  <div class="gf-form-inline">
    <div class="gf-form">
      <div class="gf-form">
        <label class="gf-form-label query-keyword fix-query-keyword width-8">Root Asset</label>
        <info-popover mode="right-absolute">
            Select an asset to pull timeseries from. (Variables can also be used via [[variable]] or $variable)
        </info-popover>
      </div>
      <gf-form-dropdown model="ctrl.target.assetQuery.target"
        css-class="gf-size-auto"
        allow-custom="false"
        lookup-text="true"
        get-options="ctrl.getOptions($query,'Asset')"
        on-change="ctrl.onChangeInternal();">
      </gf-form-dropdown>
    </div>
    <div class="gf-form">
      <gf-form-switch class="gf-form"
        label="Include Subassets" label-class="width-9 query-keyword fix-query-keyword"
        checked="ctrl.target.assetQuery.includeSubtrees" on-change="ctrl.onChangeInternal()">
      </gf-form-switch>
    </div>
    <div class="gf-form gf-form--grow">
      <label class="gf-form-label query-keyword fix-query-keyword">Label</label>
      <input type="text" class="gf-form-input" ng-model="ctrl.target.label" ng-blur="ctrl.onChangeInternal()" placeholder=""/>
      <info-popover mode="right-absolute">
        <span ng-non-bindable>
          Set the label for each timeseries. Can also access timeseries properties via {{property}}. Eg: {{description}}-{{metadata.key}}
        </span>
      </info-popover>
    </div>
  </div>
  <div class="gf-form" ng-init>
      <label class="gf-form-label query-keyword fix-query-keyword width-8">Filter</label>
      <input type="text" class="gf-form-input custom-query width-auto" ng-model="ctrl.target.expr" ng-blur="ctrl.onChangeInternal()" placeholder=""/>
      <info-popover mode="right-absolute" ng-click="showHelp = !showHelp">Click for help</info-popover>
  </div>
  <div class="gf-form--grow" ng-show="showHelp">
      <pre>
  Format: <code class="query-keyword">timeseries{options}</code>
      or  <code class="query-keyword">timeseries{options}[aggregation,granularity]</code> <br>
  Options are of the form: property comparator value <br>
  Comparator can be either
    =  (strict equality),
    != (strict inequality),
    =~ (regex equality),
    !~ (regex inequality) <br>
  Templated variables can also be used with [[variable]] or $variable.
  Example: <code class="query-keyword">timeseries{assetId=[[asset]],metadata.key1 =~ ".*test.*",isStep=1}[average,12h]</code> <br>
  Functions can also be applied to the results by adding a function property. Use '[ID]' to access the timeseries values.
    Note: No aggregates can be used when using functions.
    Instead, specify aggregations on each individual timeseries by using [ID,aggregation] or [ID,aggregation,granularity].
  Examples: <code class="query-keyword">timeseries{name=~'.*temp.*', function = ([ID] - 32) * 5/9}</code>
            <code class="query-keyword">timeseries{ function = [ID] - [ID,avg,24h] }</code>
            <code class="query-keyword">timeseries{ function = [ID,step] - [123456789,step] }</code> <br>
  To apply a special function (SUM, MAX, MIN, AVG) to all the filtered timeseries, replace ID with the special function.
  Examples: <code class="query-keyword">timeseries{metadata.type="TEMP", function=[SUM]}</code>
              ↪ yields one timeseries that is the sum of all temperature timeseries
            <code class="query-keyword">timeseries{description=~".*Error", function=[AVG,count,10m]}</code>
              ↪ yields the average number of datapoints over ten minutes of all timeseries that are errors
            <code class="query-keyword">timeseries{function=[MAX,average] - [MIN,average]}</code>
              ↪ yields the range of the timeseries aggregated by averages
            <code class="query-keyword">timeseries{function=[ID] - [AVG]}</code>
              ↪ yields the deviation of each timeseries from the average
      </pre>
  </div>
</script>
